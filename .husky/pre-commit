#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks for Short Video Maker..."

# Check for sensitive files
echo "ğŸ”’ Checking for sensitive content..."
if git diff --cached --name-only | grep -E '\.(key|pem|p12|env)$|secret|password' > /dev/null; then
  echo "âŒ Sensitive files detected! Please review:"
  git diff --cached --name-only | grep -E '\.(key|pem|p12|env)$|secret|password'
  exit 1
fi

# Check for large media files
echo "ğŸ“ Checking for large media files..."
for file in $(git diff --cached --name-only); do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file")
    if [ "$size" -gt 50000000 ]; then # 50MB
      echo "âŒ Large file detected: $file ($(($size / 1024 / 1024))MB)"
      echo "Please use Git LFS for large media files or exclude from git"
      exit 1
    fi
  fi
done

# Run linting on TypeScript files
if git diff --cached --name-only | grep '\.ts$\|\.tsx$' > /dev/null; then
  echo "ğŸ”§ Running ESLint on TypeScript files..."
  npx eslint $(git diff --cached --name-only --diff-filter=ACMR | grep '\.ts$\|\.tsx$' | tr '\n' ' ')
  if [ $? -ne 0 ]; then
    echo "âŒ ESLint failed. Please fix the issues above."
    exit 1
  fi
fi

# Run Prettier on staged files
echo "ğŸ’… Running Prettier..."
npx prettier --check $(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|md|yml|yaml)$' | tr '\n' ' ') 2>/dev/null
if [ $? -ne 0 ]; then
  echo "âŒ Prettier formatting issues found. Running auto-fix..."
  npx prettier --write $(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|md|yml|yaml)$' | tr '\n' ' ')
  echo "âœ… Files formatted. Please review and re-stage them."
  exit 1
fi

# Type checking for TypeScript
if git diff --cached --name-only | grep '\.ts$\|\.tsx$' > /dev/null; then
  echo "ğŸ“ Running TypeScript type checking..."
  npx tsc --noEmit --project tsconfig.json
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type checking failed."
    exit 1
  fi
fi

# Check for console.log statements (except in allowed files)
echo "ğŸš« Checking for console statements..."
if git diff --cached --diff-filter=ACMR | grep -E '^\+.*console\.(log|debug|info)' | grep -v -E '(test|spec|\.test\.|\.spec\.|logger)'; then
  echo "âŒ console.log/debug/info statements found. Please use the logger instead."
  exit 1
fi

# Check for TODOs in production files
echo "ğŸ“ Checking for TODO comments..."
if git diff --cached --diff-filter=ACMR | grep -E '^\+.*TODO|^\+.*FIXME' | grep -v -E '(test|spec|\.test\.|\.spec\.)'; then
  echo "âš ï¸  TODO/FIXME comments found in production code:"
  git diff --cached --diff-filter=ACMR | grep -E '^\+.*TODO|^\+.*FIXME' | grep -v -E '(test|spec|\.test\.|\.spec\.)'
  echo "Consider creating issues for these items."
fi

# Video generation project specific checks
echo "ğŸ¬ Running video generation project checks..."

# Check for proper error handling in services
if git diff --cached --name-only | grep 'src/services/.*\.ts$' > /dev/null; then
  echo "ğŸ” Checking service error handling..."
  for file in $(git diff --cached --name-only | grep 'src/services/.*\.ts$'); do
    if [ -f "$file" ] && ! grep -q "try\|catch\|throw" "$file"; then
      echo "âš ï¸  Service file $file may be missing error handling"
    fi
  done
fi

# Check for async/await patterns in video processing
if git diff --cached --name-only | grep -E '(src/short-creator|src/services)/.*\.ts$' > /dev/null; then
  echo "ğŸ”„ Checking async/await patterns..."
  if git diff --cached --diff-filter=ACMR | grep -E '^\+.*\.then\(' > /dev/null; then
    echo "âš ï¸  Found .then() usage. Consider using async/await for consistency."
  fi
fi

# Check for proper logging usage
if git diff --cached --diff-filter=ACMR | grep -E '^\+' | grep -E 'console\.(log|error|warn)' | grep -v -E '(test|spec)' > /dev/null; then
  echo "âš ï¸  Direct console usage found. Please use the project logger:"
  echo "    import { logger } from '../logger';"
  echo "    logger.info('message');"
fi

echo "âœ… Pre-commit checks completed successfully!"
echo "ğŸš€ Ready to commit clean, optimized code!"